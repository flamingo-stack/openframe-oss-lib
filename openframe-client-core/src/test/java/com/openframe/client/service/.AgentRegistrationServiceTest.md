<!-- source-hash: 3fcaa33ce17a1d8c57c2b88a1981a5e1 -->
Unit test class for the AgentRegistrationService that validates agent registration functionality using Mockito for dependency mocking.

## Key Components

- **Test Methods**
  - `registerAgent_WithNewMachine_ReturnsCredentials()` - Tests successful agent registration with new machine
  - `registerAgent_WithExistingMachine_ThrowsException()` - Tests exception handling for duplicate machine registration

- **Mock Dependencies**
  - Repository mocks (`OAuthClientRepository`, `MachineRepository`)
  - Service mocks (`OrganizationService`, `AgentRegistrationSecretValidator`)
  - Utility mocks (`AgentSecretGenerator`, `MachineIdGenerator`, `PasswordEncoder`)

- **Test Fixtures**
  - `createTestRequest()` - Helper method to create test AgentRegistrationRequest
  - Argument captors for verifying saved entities

## Usage Example

```java
// Run the test class
@ExtendWith(MockitoExtension.class)
class AgentRegistrationServiceTest {
    
    @Test
    void registerAgent_WithNewMachine_ReturnsCredentials() {
        // Arrange
        when(machineIdGenerator.generate()).thenReturn(MACHINE_ID);
        when(oauthClientRepository.existsByMachineId(MACHINE_ID)).thenReturn(false);
        
        // Act
        AgentRegistrationResponse response = agentRegistrationService.register(INITIAL_KEY, request);
        
        // Assert
        assertEquals(MACHINE_ID, response.getMachineId());
        verify(oauthClientRepository).save(any());
        verify(machineRepository).save(any());
    }
}
```

The tests ensure proper validation, OAuth client creation, machine persistence, and error handling for duplicate registrations.