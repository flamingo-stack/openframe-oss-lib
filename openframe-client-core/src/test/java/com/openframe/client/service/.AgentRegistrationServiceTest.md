<!-- source-hash: 3fcaa33ce17a1d8c57c2b88a1981a5e1 -->
Unit test class that validates the agent registration functionality, ensuring proper creation of OAuth clients and machine records for new agent deployments.

## Key Components

- **Test Setup**: Comprehensive mock configuration for all dependencies including repositories, validators, and generators
- **Registration Flow Tests**: Validates successful agent registration with credential generation and database persistence
- **Error Handling Tests**: Verifies proper exception handling when attempting to register duplicate machines
- **Argument Captors**: Captures and validates the exact objects saved to repositories during registration
- **Mock Interactions**: Verifies all expected service interactions occur in the correct sequence

## Usage Example

```java
@ExtendWith(MockitoExtension.class)
class AgentRegistrationServiceTest {
    
    @Mock
    private OAuthClientRepository oauthClientRepository;
    
    @Test
    void registerAgent_WithNewMachine_ReturnsCredentials() {
        // Arrange
        when(machineIdGenerator.generate()).thenReturn("test-machine-id");
        when(oauthClientRepository.existsByMachineId("test-machine-id")).thenReturn(false);
        
        // Act
        AgentRegistrationResponse response = agentRegistrationService.register(INITIAL_KEY, request);
        
        // Assert
        assertEquals("test-machine-id", response.getMachineId());
        verify(oauthClientRepository).save(any());
        verify(machineRepository).save(any());
    }
}
```

The test class covers both successful registration scenarios and error conditions, using argument captors to verify that saved entities contain the expected field values and relationships.