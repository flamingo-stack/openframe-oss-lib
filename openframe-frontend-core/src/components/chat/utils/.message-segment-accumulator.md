<!-- source-hash: ae2b519bebd5a349044f519d91b91e42 -->
The MessageSegmentAccumulator manages the real-time accumulation and processing of message segments during streaming conversations, handling text buffers, tool executions, and approval workflows.

## Key Components

- **MessageSegmentAccumulator**: Main class that accumulates segments with state management
- **AccumulatorCallbacks**: Interface defining approval action handlers
- **State Management**: Methods for serialization, initialization, and reset operations
- **Text Handling**: Automatic text buffer management and segment merging
- **Tool Execution**: Tracks EXECUTING_TOOL â†’ EXECUTED_TOOL state transitions
- **Approval System**: Manages pending approvals and status updates

## Usage Example

```typescript
import { createMessageSegmentAccumulator } from './message-segment-accumulator'

// Create accumulator with approval callbacks
const accumulator = createMessageSegmentAccumulator({
  onApprove: async (requestId) => {
    console.log(`Approved: ${requestId}`)
  },
  onReject: async (requestId) => {
    console.log(`Rejected: ${requestId}`)
  }
})

// Add streaming text
accumulator.appendText("Hello ")
accumulator.appendText("world!") // Merges with previous text

// Add tool execution
accumulator.addToolExecution({
  type: 'tool_execution',
  data: {
    type: 'EXECUTING_TOOL',
    integratedToolType: 'filesystem',
    toolFunction: 'readFile',
    parameters: { path: './config.json' }
  }
})

// Process approval request
accumulator.addApprovalRequest(
  'req-123',
  'rm -rf temp/',
  'Remove temporary files',
  'DESTRUCTIVE'
)

// Get all segments
const segments = accumulator.getSegments()
```