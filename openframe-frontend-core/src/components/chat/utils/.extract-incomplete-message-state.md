<!-- source-hash: 9bcf6f0eae9543385fec745e5f5512eb -->
A utility for extracting incomplete message state from historical assistant messages, enabling seamless continuation of message building across realtime connections when messages contain pending operations or tool executions.

## Key Components

- **`extractIncompleteMessageState`** - Main function that analyzes the last processed message to extract incomplete state including pending approvals, executing tools, and existing message segments

## Usage Example

```typescript
import { extractIncompleteMessageState } from './extract-incomplete-message-state'
import type { ProcessedMessage } from '../types'

// Extract state from the last assistant message
const lastMessage: ProcessedMessage = {
  role: 'assistant',
  content: [
    { type: 'text', content: 'Starting deployment...' },
    { 
      type: 'tool_execution', 
      data: { 
        type: 'EXECUTING_TOOL',
        integratedToolType: 'kubernetes',
        toolFunction: 'deployApp',
        parameters: { namespace: 'prod' }
      }
    }
  ]
}

const incompleteState = extractIncompleteMessageState(lastMessage)

if (incompleteState) {
  console.log('Found incomplete message with:')
  console.log('- Existing segments:', incompleteState.existingSegments?.length)
  console.log('- Executing tools:', incompleteState.executingTools?.size)
  console.log('- Pending approvals:', incompleteState.pendingApprovals?.size)
  
  // Initialize realtime processor with existing state
  realtimeProcessor.initialize({
    existingSegments: incompleteState.existingSegments,
    pendingApprovals: incompleteState.pendingApprovals,
    executingTools: incompleteState.executingTools
  })
}
```

The function returns `undefined` for complete messages or non-assistant messages, and extracts tool executions and approval requests that are still in progress to maintain continuity across connection resets.